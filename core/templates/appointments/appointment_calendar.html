{% load static custom_tags %}
<div class="calendar-card card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <button class="btn btn-outline-primary btn-sm" id="prevMonthBtn"
            data-month="{{ prev_month }}" data-year="{{ prev_year }}">
            <i class="bi bi-chevron-left"></i> Anterior
        </button>
        <span class="calendar-title">
            <i class="bi bi-calendar3 me-2"></i>
            Calendario de Citas - {{ current_date|date:"F Y" }}
        </span>
        <button class="btn btn-outline-primary btn-sm" id="nextMonthBtn"
            data-month="{{ next_month }}" data-year="{{ next_year }}">
            Siguiente <i class="bi bi-chevron-right"></i>
        </button>
    </div>

    <div class="card-body p-4">
        <!-- Header - Día de la semana -->
        <div class="row border bg-primary text-white rounded-top calendar-weekdays">
            {% for day in weekday_headers %}
                <div class="col p-2 text-center fw-bold">{{ day }}</div>
            {% endfor %}
        </div>
        
        <!-- Cuadricula de Calendario -->
        {% for week in month_days %}
        <div class="row border calendar-week">
            {% for day in week %}
                <div class="col p-2 border text-center calendar-cell {% if day.month != current_month_num %}bg-light text-muted{% endif %}">
                    <!-- Nombre del día y número -->
                    <div class="small text-muted">{{ day|date:"D" }}</div>
                    <div class="fw-bold">
                        <a href="{% url 'appointment_list' %}?date={{ day|date:'Y-m-d' }}"
                           class="calendar-day-link text-decoration-none {% if day.month == current_month_num %}text-dark{% else %}text-muted{% endif %}"
                           data-date="{{ day|date:'Y-m-d' }}">
                            {{ day.day }}
                        </a>
                    </div>
                    
                    <!-- Contabilización de citas -->
                    {% if day.month == current_month_num %}
                        {% with count=appointments_dict|get_item:day.isoformat %}
                            {% if count and count > 0 %}
                                <div class="mt-1">
                                    <span class="badge bg-primary rounded-pill">
                                        {{ count }} cita{{ count|pluralize }}
                                    </span>
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>

<style>
    :root {
        --primary-blue: #007bff;
        --light-blue: #e3f2fd;
        --dark-text: #2c3e50;
        --muted-text: #6c757d;
        --border-color: #dee2e6;
        --background-light: #f8f9fa;
    }

    .calendar-card.card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .calendar-title {
        color: var(--primary-blue);
        font-weight: 600;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .calendar-weekdays {
        font-size: 1rem;
        background: linear-gradient(135deg, var(--primary-blue), #0056b3);
        color: white;
        border-radius: 8px 8px 0 0;
        margin-bottom: 0;
    }

    .calendar-week {
        background: var(--background-light);
    }

    .calendar-cell {
        min-height: 90px;
        vertical-align: top;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        border: 1px solid var(--border-color);
        background: white;
        transition: background 0.2s;
        position: relative;
        padding: 0.75rem 0.25rem;
    }

    .calendar-cell.bg-light {
        background: #f4f6fa !important;
        color: var(--muted-text) !important;
    }

    .calendar-cell .fw-bold a {
        font-size: 1.2rem;
        color: var(--primary-blue);
        transition: color 0.2s;
    }

    .calendar-cell .fw-bold a:hover {
        color: #0056b3;
        text-decoration: underline;
    }

    .calendar-cell .badge {
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }

    .calendar-cell .small {
        font-size: 0.85rem;
        color: var(--muted-text);
    }

    .calendar-cell.today {
        border: 2px solid var(--primary-blue);
        background: var(--light-blue);
    }

    @media (max-width: 768px) {
        .calendar-title {
            font-size: 1rem;
        }
        .calendar-cell {
            min-height: 60px;
            font-size: 0.95rem;
        }
        .calendar-weekdays {
            font-size: 0.95rem;
        }
    }
</style>